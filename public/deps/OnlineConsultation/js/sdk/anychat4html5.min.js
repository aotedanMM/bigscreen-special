var AnyChatSDK=function(){var n=(window.PeerConnection||window.webkitPeerConnection00||window.webkitRTCPeerConnection||window.mozRTCPeerConnection);var g=(window.URL||window.webkitURL||window.msURL||window.oURL);var c=(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia);var b=(window.mozRTCIceCandidate||window.RTCIceCandidate);var d=(window.mozRTCSessionDescription||window.RTCSessionDescription);var j=!!navigator.mozGetUserMedia;var l={iceServers:[{url:"stun:stun.l.google.com:19302"}]};function o(){this.events={}}o.prototype.on=function(p,q){this.events[p]=this.events[p]||[];this.events[p].push(q)};o.prototype.emit=function(q,s){var u=this.events[q],r=Array.prototype.slice.call(arguments,1),t,p;if(!u){return}for(t=0,p=u.length;t<p;t++){u[t].apply(null,r)}};function h(q){for(var p in q){return false}return true}function k(){this.localStatus={socketConnect:false,sdkauthpass:"",appGuid:"",logincmd:{},loginexcmd:{},roomid:-1,roomname:"",roompass:"",roomparam:0,selfuserid:-1};this.sdkoptionData={};this.userInfoData={};this.friendInfoData={};this.groupInfoData={};this.objectInfoData={};this.roomusers=[];this.queueWaitSeconds=0;this.queueWaitTimer=-1;this.localMediaStream=null;this.localVideoObject=null;this.localVideoStreamBind=false;this.connections=[];this.remoteMediaStreams=[];this.remoteVideoObjects=[];this.remoteVideoStreamBind=[];this.peerConnections={};this.socket=null}k.prototype=new o();function e(p,q){console.warn(p);if(q.length){console.log("\t "+q)}}function a(){f();this.anychat.userInfoData={};this.anychat.friendInfoData={};this.anychat.groupInfoData={};this.anychat.objectInfoData={};this.anychat.localStatus.logincmd={};this.anychat.localStatus.loginexcmd={};this.anychat.localStatus.selfuserid=-1}function f(){this.anychat.closeLocalStream();this.anychat.closeRemoteStream(-1);this.anychat.roomusers=[];this.anychat.localStatus.roomid=-1;this.anychat.localStatus.roomname=""}k.prototype.InitSDK=function(q){var p=this;this.on("_notifyMessage",function(x){var t=p.localStatus;if(x.event==WM_GV_CONNECT){if(x.lParam==0&&!h(t.logincmd)){p.socket.sendCommand("login",t.logincmd)}else{if(x.lParam==0&&!h(t.loginexcmd.length)){p.socket.sendCommand("loginex",t.loginexcmd)}}}else{if(x.event==WM_GV_LOGINSYSTEM){if(x.lParam==0){p.localStatus.selfuserid=x.wParam;for(var s in p.sdkoptionData){p.socket.sendCommand(p.sdkoptionData[s].command,p.sdkoptionData[s].param)}if(p.localStatus.roomid!=-1){p.socket.sendCommand("enterroom",{roomid:t.roomid,password:t.roompass,param:t.roomparam})}else{if(p.localStatus.roomname.length){p.socket.sendCommand("enterroomex",{roomname:t.roomname,password:t.roompass})}}}}else{if(x.event==WM_GV_ENTERROOM){var u=x.wParam;var w=x.lParam;if(w){p.roomusers.push(u)}else{for(var v=0;v<p.roomusers;v++){if(p.roomusers[v]==u){delete p.roomusers[v];break}}}}else{if(x.event==WM_GV_FRIENDSTATUS){var u=x.wParam;var r=x.lParam;if(r==0){delete p.friendInfoData[u]}}}}}p.emit("OnNotifyMessage",x.event,x.wParam,x.lParam)});this.on("_videoCallEvent",function(r){p.emit("OnVideoCallEvent",r.event,r.userid,r.errorcode,r.flags,r.param,r.userstr)});this.on("_transBufferEvent",function(r){p.emit("OnTransBuffer",r.userid,r.buf,r.buf.length)});this.on("_textMessageEvent",function(r){p.emit("OnTextMessage",r.fromuserid,r.touserid,r.secret,r.msgbuf,r.msgbuf.length)});this.on("_userBaseInfo",function(r){var s={nickname:r.nickname,level:r.level,internetip:r.internetip};p.userInfoData[r.userid]=s});this.on("_userFriendInfo",function(r){var s={groupid:r.groupid,status:r.status,t1:r.t1,t2:r.t2,t3:r.t3,t4:r.t4,t5:r.t5,t6:r.t6,t7:r.t7,t8:r.t8,t9:r.t9,t10:r.t10};p.friendInfoData[r.userid]=s});this.on("_groupBaseInfo",function(r){var s={groupname:r.groupname};p.groupInfoData[r.groupid]=s});this.on("_roomUserList",function(s){p.roomusers=[];var r=s.useridlist.split(";");for(i=0;i<r.length;i++){if(r[i]!=""){p.roomusers.push(r[i])}}});this.on("_objectBaseInfo",function(s){var r={};if(typeof p.objectInfoData[s.objecttype+"_"+s.objectid]!="undefined"){r=p.objectInfoData[s.objecttype+"_"+s.objectid].status}var t={objecttype:s.objecttype,objectid:s.objectid,flags:s.flags,objectname:s.objectname,priority:s.priority,attribute:s.attribute,inttag:s.inttag,objectdesc:s.objectdesc,strtag:s.strtag,status:r};p.objectInfoData[s.objecttype+"_"+s.objectid]=t});this.on("_objectStatus",function(t){for(var s in p.objectInfoData){if(p.objectInfoData[s].objecttype==t.objecttype&&p.objectInfoData[s].objectid==t.objectid){for(var r in t){if(r=="objecttype"||r=="objectid"){continue}p.objectInfoData[s].status[r]=t[r]}break}}});this.on("_objectEvent",function(s){if(s.event==ANYCHAT_QUEUE_EVENT_ENTERRESULT){p.queueWaitSeconds=0;if(p.queueWaitTimer==-1){p.queueWaitTimer=setInterval(function(){p.queueWaitSeconds++},1000)}}else{if(s.event==ANYCHAT_QUEUE_EVENT_LEAVERESULT){if(p.queueWaitTimer!=-1){clearInterval(p.queueWaitTimer)}}else{if(s.event==ANYCHAT_AREA_EVENT_LEAVERESULT&&s.objecttype==ANYCHAT_OBJECT_TYPE_AREA){for(var r in p.objectInfoData){if(p.objectInfoData[r].objecttype==ANYCHAT_OBJECT_TYPE_QUEUE){delete p.objectInfoData[r]}}}}}p.emit("OnObjectEvent",s.objecttype,s.objectid,s.event,s.param1,s.param2,s.param3,s.param4,s.strparam)})};k.prototype.Connect=function(u,q){var p,t=this;var r=parseInt(q)+2;var s="https:"==document.location.protocol?true:false;var v="ws://"+u+":"+r;if(s){v="wss://"+u+":"+r}if(typeof MozWebSocket!="undefined"){p=this.socket=new MozWebSocket(v,"anychat-protocol")}else{p=this.socket=new WebSocket(v,"anychat-protocol")}p.sendCommand=function(w,x){p.send(JSON.stringify({eventName:w,data:x}))};p.onopen=function(){p.sendCommand("connect",{host:u,port:r,appGuid:t.localStatus.appGuid});t.emit("socket_opened",p);t.localStatus.socketConnect=true};p.onmessage=function(x){var w=JSON.parse(x.data);if(w.eventName){t.emit(w.eventName,w.data)}else{t.emit("socket_receive_message",p,w)}};p.onerror=function(w){if(t.localStatus.socketConnect){t.emit("OnNotifyMessage",WM_GV_LINKCLOSE,0,101)}else{t.emit("OnNotifyMessage",WM_GV_CONNECT,0,115)}t.emit("socket_error",w,p);t.localStatus.socketConnect=false};p.onclose=function(w){t.closeLocalStream();t.closeRemoteStream(-1);t.emit("OnNotifyMessage",WM_GV_LINKCLOSE,0,0);t.socket=null;t.localStatus.socketConnect=false;a()};this.on("_ice_candidate",function(y){var w=t.peerConnections[y.userid];if(w){var x=new b(y);w.addIceCandidate(x)}t.emit("get_ice_candidate",x)});this.on("_answer",function(w){t.receiveAnswer(w.userid,w.sdp);t.emit("get_answer",w)});return 0};k.prototype.bindVideoStream=function(q){var r=this;var p=null;var s=null;if(q==-1||q==r.localStatus.selfuserid){if(r.localVideoStreamBind||!r.localMediaStream||!r.localVideoObject){return}p=r.localVideoObject;s=r.localMediaStream;r.localVideoStreamBind=true}else{if(r.remoteVideoStreamBind[q]||!r.remoteVideoObjects[q]||!r.remoteMediaStreams[q]){return}p=r.remoteVideoObjects[q];s=r.remoteMediaStreams[q];r.remoteVideoStreamBind[q]=true}if(!p||!s){return}if(navigator.mozGetUserMedia){p.mozSrcObject=s;p.play()}p.src=g.createObjectURL(s);p.play();p.style.display=""};k.prototype.createStream=function(){var p=this;var q={video:{mandatory:{minAspectRatio:1.333,maxAspectRatio:1.334},optional:[{maxFrameRate:15},{minWidth:320},{minHeigth:240},{maxWidth:1280},{maxHeigth:720}]},audio:true};if(c){c.call(navigator,q,function(r){p.localMediaStream=r;p.bindVideoStream(-1);p.openRemoteStream()},function(r){p.emit("stream_create_error",r)})}else{p.emit("stream_create_error",new Error("WebRTC is not yet supported in this browser."))}};k.prototype.closeLocalStream=function(){var p=this;if(p.localMediaStream){p.localMediaStream.active=false;p.localMediaStream.stop();p.localMediaStream=null}p.localVideoObject=null;p.localVideoStreamBind=false};k.prototype.openRemoteStream=function(){var t=this;if(!t.localMediaStream){return}var s,p;for(s=0,p=t.connections.length;s<p;s++){var r=t.connections[s];if(!t.peerConnections[r]){t.peerConnections[r]=t.createPeerConnection(r);var q=t.peerConnections[r];q.addStream(t.localMediaStream);q.createOffer(function(u){q.setLocalDescription(u);t.socket.send(JSON.stringify({eventName:"__offer",data:{sdp:u.sdp,userid:r}}))})}t.bindVideoStream(r)}};k.prototype.closeRemoteStream=function(r){var s=this;if(r==-1){var q,p;for(q=0,p=s.connections.length;q<p;q++){var t=s.connections[q];if(s.remoteMediaStreams[t]){delete s.remoteMediaStreams[t]}if(s.remoteVideoObjects[t]){s.remoteVideoObjects[t].style.display="none";delete s.remoteVideoObjects[t]}s.remoteVideoStreamBind[t]=false;if(s.peerConnections[t]){s.peerConnections[t].close();delete s.peerConnections[t]}}s.connections=[];s.peerConnections={};s.remoteMediaStreams=[];s.remoteVideoObjects=[];s.remoteVideoStreamBind=[]}else{if(s.remoteMediaStreams[r]){delete s.remoteMediaStreams[r]}if(s.remoteVideoObjects[r]){s.remoteVideoObjects[r].style.display="none";delete s.remoteVideoObjects[r]}s.remoteVideoStreamBind[r]=false;if(s.peerConnections[r]){s.peerConnections[r].close();delete s.peerConnections[r]}s.connections.splice(r,1)}};k.prototype.attachStream=function(r,q){var p=document.getElementById(q);if(navigator.mozGetUserMedia){p.mozSrcObject=r;p.play()}else{p.src=webkitURL.createObjectURL(r)}p.src=webkitURL.createObjectURL(r)};k.prototype.receiveAnswer=function(q,p){var t=this;var s=this.peerConnections[q];if(!s){return}var r=new d();r.sdp=p;r.type="answer";s.setRemoteDescription(r);t.socket.sendCommand("__offer_ack",{userid:q})};k.prototype.createPeerConnection=function(q){var r=this;var s={optional:[{DtlsSrtpKeyAgreement:false}]};var p=new n(l,s);p.onicecandidate=function(t){if(t.candidate){r.socket.send(JSON.stringify({eventName:"__ice_candidate",data:{label:t.candidate.sdpMLineIndex,candidate:t.candidate.candidate,userid:q}}))}r.emit("pc_get_ice_candidate",t.candidate,q,p)};p.onopen=function(){r.emit("pc_opened",q,p)};p.onaddstream=function(t){r.remoteMediaStreams[q]=t.stream;r.bindVideoStream(q);r.emit("pc_add_stream",t.stream,q,p)};p.ondatachannel=function(t){r.addDataChannel(q,t.channel);r.emit("pc_add_data_channel",t.channel,q,p)};return p};k.prototype.closePeerConnection=function(p){if(!p){return}p.close()};k.prototype.GetVersion=function(p){return"2.0.0.0"};k.prototype.GetSDKOptionString=function(p){return""};k.prototype.SetServerAuthPass=function(p){return 0};k.prototype.Login=function(s,q,p){var r=this;r.localStatus.logincmd={username:s,password:q,param:parseInt(p),sdkauthpass:r.localStatus.sdkauthpass,appGuid:r.localStatus.appGuid};if(r.localStatus.socketConnect){r.socket.sendCommand("login",r.localStatus.logincmd)}return 0};k.prototype.LoginEx=function(v,t,r,p,s,q){var u=this;u.localStatus.appGuid=p;u.localStatus.loginexcmd={nickname:v,userid:parseInt(t),struserid:r,appGuid:p,sigstr:s,strparam:q};if(u.localStatus.socketConnect){u.socket.sendCommand("loginex",u.localStatus.loginexcmd)}return 0};k.prototype.EnterRoom=function(q,s,p){var r=this;if(r.localStatus.socketConnect){r.socket.sendCommand("enterroom",{roomid:parseInt(q),password:s,param:parseInt(p)})}r.localStatus.roomid=q;r.localStatus.roompass=s;r.localStatus.roomparam=p;return 0};k.prototype.EnterRoomEx=function(p,r){var q=this;if(q.localStatus.socketConnect){q.socket.sendCommand("enterroomex",{roomname:p,password:r})}q.localStatus.roomname=p;q.localStatus.roompass=r;return 0};k.prototype.QueryUserStateString=function(q,p){var r=this;if(typeof r.userInfoData[q]!="undefined"){if(p==BRAC_USERSTATE_NICKNAME){return r.userInfoData[q].nickname}else{if(p==BRAC_USERSTATE_INTERNETIP){return r.userInfoData[q].internetip}else{if(p==BRAC_USERSTATE_LOCALIP){return r.userInfoData[q].internetip}}}}return""};k.prototype.QueryUserStateInt=function(q,p){var r=this;if(typeof r.userInfoData[q]!="undefined"){if(p==BRAC_USERSTATE_LEVEL){return r.userInfoData[q].level}}return 0};k.prototype.GetRoomOnlineUsers=function(){return this.roomusers};k.prototype.LeaveRoom=function(p){var q=this;if(q.localStatus.socketConnect){q.socket.sendCommand("leaveroom",{roomid:parseInt(p)})}f();return 0};k.prototype.Logout=function(){var p=this;if(p.localStatus.socketConnect){p.socket.sendCommand("logout",{errorcode:0})}p.socket=null;p.localStatus.socketConnect=false;a();return 0};k.prototype.SetVideoPos=function(r,s,q){var u=this;if(!u.localStatus.socketConnect){return -1}var v=parseInt(r);var t=(v==-1||u.localStatus.selfuserid==v);var w=q+"_videobk";var x=document.getElementById(w);if(!x){x=document.createElement("img");x.id=w;x.style.width="100%";x.style.height="100%";x.src="./images/anychatbk.jpg";s.appendChild(x)}if(v==0){return}var p=document.getElementById(q);if(p==null){p=document.createElement("video");p.id=q;p.style.width="100%";p.style.height="100%";p.style.zIndex=1;p.style.display="none";p.autoplay=true;p.muted=t?true:false;s.insertBefore(p,s.childNodes[0])}if(t){u.localVideoObject=p}else{u.remoteVideoObjects[v]=p}u.bindVideoStream(v);return 0};k.prototype.UserCameraControl=function(r,s){var t=this;var u=!!parseInt(s);var p=parseInt(r);if(!t.localStatus.socketConnect){return -1}t.socket.sendCommand("usercameracontrol",{userid:p,bopen:parseInt(s)});if(p==-1||t.localStatus.selfuserid==p){if(u&&!t.localMediaStream){t.createStream()}else{if(!u){t.closeLocalStream()}}}else{var q=false;for(i=0,m=t.connections.length;i<m;i++){if(t.connections[i]==p){q=true;break}}if(u){if(q){return}t.connections.push(p);t.openRemoteStream()}else{if(!q){return}t.closeRemoteStream(p)}}return 0};k.prototype.UserSpeakControl=function(p,q){var r=this;if(!r.localStatus.socketConnect){return -1}r.socket.sendCommand("userspeakcontrol",{userid:parseInt(p),bopen:parseInt(q)});return 0};k.prototype.SetSDKOptionString=function(p,s){var q=this;if(parseInt(p)==BRAC_SO_CLOUD_APPGUID){q.localStatus.appGuid=s}if(!q.localStatus.socketConnect){var r={command:"setsdkoptionstring",param:{optname:parseInt(p),value:s}};q.sdkoptionData[p]=r}else{q.socket.sendCommand("setsdkoptionstring",{optname:parseInt(p),value:s})}return 0};k.prototype.SetSDKOptionInt=function(p,s){var q=this;if(!q.localStatus.socketConnect){var r={command:"setsdkoptionint",param:{optname:parseInt(p),value:parseInt(s)}};q.sdkoptionData[p]=r}else{q.socket.sendCommand("setsdkoptionint",{optname:parseInt(p),value:parseInt(s)})}};k.prototype.VideoCallControl=function(r,q,v,u,p,t){var s=this;if(!s.localStatus.socketConnect){return -1}s.socket.sendCommand("videocallcontrol",{event:parseInt(r),userid:parseInt(q),errorcode:parseInt(v),flags:parseInt(u),param:parseInt(p),userstr:t});return 0};k.prototype.TransBuffer=function(q,p,s){var r=this;if(!r.localStatus.socketConnect){return -1}r.socket.sendCommand("transbuffer",{userid:parseInt(q),buf:p});return 0};k.prototype.SendTextMessage=function(q,p,t,s){var r=this;if(!r.localStatus.socketConnect){return -1}r.socket.sendCommand("sendtextmessage",{userid:parseInt(q),secret:parseInt(p),msgbuf:t});return 0};k.prototype.GetUserFriends=function(){var r=this;var q=new Array();for(var p in r.friendInfoData){q.push(p)}return q};k.prototype.GetFriendStatus=function(q){var p=this;if(typeof p.friendInfoData[q]!="undefined"){return p.friendInfoData[q].status}else{return 0}};k.prototype.GetUserGroups=function(){var r=this;var p=new Array();for(var q in r.groupInfoData){p.push(q)}return p};k.prototype.GetGroupFriends=function(s){var r=this;var q=new Array();for(var p in r.friendInfoData){if(r.friendInfoData[p].groupid==s){q.push(p)}}return q};k.prototype.GetUserInfo=function(p,r){var q=this;if(typeof q.friendInfoData[p]!="undefined"){return q.friendInfoData[p]["t"+r]}else{return""}};k.prototype.GetGroupName=function(q){var p=this;if(typeof p.groupInfoData[q]!="undefined"){return p.groupInfoData[q].groupname}else{return""}};k.prototype.UserInfoControl=function(q,s,u,t,p){var r=this;if(!r.localStatus.socketConnect){return -1}r.socket.sendCommand("userinfocontrol",{userid:parseInt(q),ctrlcode:parseInt(s),wparam:parseInt(u),lparam:parseInt(t),strvalue:p});return 0};k.prototype.ObjectGetIdList=function(p){var r=this;var s=new Array();for(var q in r.objectInfoData){if(r.objectInfoData[q].objecttype==p){s.push(r.objectInfoData[q].objectid)}}return s};k.prototype.GetObjectIntValue=function(q,p,s){var u=this;var v=0;for(var t in u.objectInfoData){if(u.objectInfoData[t].objecttype==q&&u.objectInfoData[t].objectid==p){if(s==ANYCHAT_OBJECT_INFO_FLAGS){v=u.objectInfoData[t].flags}else{if(s==ANYCHAT_OBJECT_INFO_PRIORITY){v=u.objectInfoData[t].priority}else{if(s==ANYCHAT_OBJECT_INFO_ATTRIBUTE){v=u.objectInfoData[t].attribute}else{if(s==ANYCHAT_OBJECT_INFO_INTTAG){v=u.objectInfoData[t].inttag}else{if(s==ANYCHAT_QUEUE_INFO_WAITTIMESECOND){v=u.queueWaitSeconds}else{for(var r in u.objectInfoData[t].status){if(parseInt(r)==s){v=parseInt(u.objectInfoData[t].status[r]);break}}}}}}}break}}return v};k.prototype.GetObjectStringValue=function(q,p,s){var u=this;var v="";for(var t in u.objectInfoData){if(u.objectInfoData[t].objecttype==q&&u.objectInfoData[t].objectid==p){if(s==ANYCHAT_OBJECT_INFO_NAME){v=u.objectInfoData[t].objectname}else{if(s==ANYCHAT_OBJECT_INFO_DESCRIPTION){v=u.objectInfoData[t].objectdesc}else{if(s==ANYCHAT_OBJECT_INFO_STRINGTAG){v=u.objectInfoData[t].strtag}else{for(var r in u.objectInfoData[t].status){if(parseInt(r)==s){v=u.objectInfoData[t].status[r];break}}}}}break}}return v};k.prototype.SetObjectStringValue=function(q,p,r,t){var s=this;if(!s.localStatus.socketConnect){return -1}s.socket.sendCommand("setobjectstrvalue",{objecttype:parseInt(q),objectid:parseInt(p),infoname:parseInt(r),value:t});return 0};k.prototype.SetObjectIntValue=function(q,p,r,t){var s=this;if(!s.localStatus.socketConnect){return -1}s.socket.sendCommand("setobjectintvalue",{objecttype:parseInt(q),objectid:parseInt(p),infoname:parseInt(r),value:parseInt(t)});return 0};k.prototype.ObjectControl=function(p,u,r,x,w,v,t,q){var s=this;if(!s.localStatus.socketConnect){return -1}s.socket.sendCommand("objectcontrol",{objecttype:parseInt(p),objectid:parseInt(u),ctrlcode:parseInt(r),param1:parseInt(x),param2:parseInt(w),param3:parseInt(v),param4:parseInt(t),strparam:q});return 0};return new k()};
